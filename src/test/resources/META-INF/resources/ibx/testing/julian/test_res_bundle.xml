<?xml version="1.0" encoding="UTF-8"?>
<ibx-res-bundle name="test_res_bundle.xml" loadContext="bundle">
	<strings>
		<string-file src="./test_res_strings.txt" default="false"/>
		<string-bundle>
			<![CDATA[
			{
				"language":"ibx_default",
				"strings":
				{
				}
			}
		]]>
		</string-bundle>
	</strings>

	<styles>
		<style-file src="./test_res_styles.css"/>
		<style-sheet>
		<![CDATA[
			.ibx-data-grid
			{
				box-sizing:border-box;
				overflow:auto;
			}
			.dgrid-header-col-bar, .dgrid-header-row-bar
			{
				padding:2px;
				background-color:#ccc;
			}
			.dgrid-header-col, .dgrid-header-row
			{
				padding:3px;
				border:1px outset;
				box-sizing:border-box;
			}
			.dgrid-header-col-splitter
			{
				min-width:0px;
				width:2px;
				background-color:transparent;
				box-sizing:border-box;
			}
			.dgrid-grid
			{
				padding:2px;
				border-top:1px solid black;
				overflow:auto;
			}
			.dgrid-row
			{
				flex:0 0 auto;
			}
			.dgrid-cell
			{
				height:1em;
				flex:0 0 auto;
				padding:3px;
				border-right:1px solid #ccc;
				border-bottom:1px solid #ccc;
			}
			.dgrid-cell-padding
			{
				flex:1 1 auto;
			}
			.ibx-data-grid-heading
			{
				padding:3px;
				border:1px outset;
				box-sizing:border-box;
			}
			.ibx-data-grid-heading-splitter
			{
				min-width:0px;
				width:2px;
				background-color:transparent;
				box-sizing:border-box;
			}
			.ibx-data-grid-cell
			{
				box-sizing:border-box;
				border-right:1px solid #ccc;
				border-bottom:1px solid #ccc;
			}
			.ibx-data-grid-cell-padding
			{
			}
			.test-class
			{
				font-size:2em;
			}
		]]>
		</style-sheet>
	</styles>

	<markup>
		<markup-file src="./test_res_markup.xml"/>
		<markup-block>
		</markup-block>
	</markup>

	<scripts>
		<script-file src="./test_res_script.js"/>
		<script-file src="../../ibxtools/shared_resources/js/ibfs.js" loadContext="ibx"/>
		<script-block>
		<![CDATA[
			var testProps = 
			[
				{
					"displayName":"Background Color",
					"displayValue":"White",
					"name":"backgroundColor",
					"value":"white",
					"type":"string",
					"uiType":"colorPicker",
					"expanded":false,
				},
				{
					"displayName":"Border",
					"displayValue":"1px solid black",
					"name":"border",
					"value":"1px solid black",
					"type":"string",
					"uiType":"borderSelector",
					"expanded":false,
					"props":
					[
						{
							"displayName":"Left",
							"displayValue":"1px solid black",
							"name":"left",
							"value":"1px solid black",
							"type":"string",
							"uiType":"borderSelector",
							"expanded":false,
							"props":
							[
								{
									"displayName":"Width",
									"displayValue":"1px",
									"name":"width",
									"value":"1px",
									"type":"string",
									"uiType":"textField",
								},
								{
									"displayName":"Style",
									"displayValue":"Solid",
									"name":"style",
									"value":"solid",
									"type":"string",
									"uiType":"select",
									"values":
									{
										"solid":
										{
											"displayName":"Solid",
											"value":"solid",
										},
										"dashed":
										{
											"displayName":"Dashed",
											"value":"dashed",
										},
										"dotted":
										{
											"displayName":"Dotted",
											"value":"dotted",
										},
									},
								},
								{
									"displayName":"Color",
									"displayValue":"red",
									"name":"color",
									"value":"red",
									"type":"color",
									"uiType":"colorPicker",
								},
							]
						}
					]
				}
			];

			$.widget("ibi.ibxDataGrid", $.ibi.ibxGrid,
			{
				options:
				{
					colMap:[], //entries: {title:"column title", size:"100px"}...size can be "*" meaning "flex 1 1 auto".
					showColHeaders:true,
					showRowHeaders:false,
					
					/*frame stuff*/
					cols:"auto 1fr",
					rows:"auto 1fr",
					classes:
					{
						colHeaderBarClass:"dgrid-header-col-bar",
						colHeaderClass:"dgrid-header-col",
						colHeaderSplitterClass:"dgrid-header-col-splitter",
						rowHeaderBarClass:"dgrid-header-row-bar",
						rowHeaderClass:"dgrid-header-row",
						rowHeaderSplitterClass:"dgrid-header-row-splitter",
						gridClass:"dgrid-grid",
						gridRow:"dgrid-row",
						cellClass:"dgrid-cell",
					},
					gridOptions:
					{
						align:"stretch",
						justify:"start",
					}
				},
				_widgetClass:"ibx-data-grid",
				_create:function()
				{
					var options = this.options;
					var classes = options.classes;
					var colHeaderBar = this._colHeaderBar = $("<div>").ibxHBox().ibxAddClass(classes.colHeaderBarClass).data({ibxCol:"2", ibxRow:"1"});
					var rowHeaderBar = this._rowHeaderBar = $("<div>").ibxVBox().ibxAddClass(classes.rowHeaderBarClass).data({ibxCol:"1", ibxRow:"2"});
					var grid = this._grid = $("<div>").ibxVBox({align:"stretch"}).ibxAddClass(classes.gridClass).data({ibxCol:"2", ibxRow:"2"});
					this.add([colHeaderBar[0], rowHeaderBar[0], grid[0]]);
					this._super();
				},
				_buildHeaders:function()
				{
					var options = this.options;
					var classes = options.classes;

					this._colHeaderBar.ibxWidget("remove");
					for(var i = 0; i < options.colMap.length; ++i)
					{
						var cInfo = options.colMap[i];
						var size = (cInfo.size == "*") ? "flex:1 1 auto" : "width:"+cInfo.size;
						var cHeading = $(sformat("<div class='{1}' style='{2};'>{3}</div>", classes.colHeaderClass, size, cInfo.title));
						cHeading.ibxButtonSimple({justify:"start"});
						this._colHeaderBar.ibxWidget("add", cHeading);
						cInfo._curSize = cHeading.outerWidth();

						if(i == options.colMap.length-1)
							continue;

						var splitter = $(sformat("<div class='{1}'>", classes.colHeaderSplitterClass)).ibxSplitter({resize:"first"}).on("ibx_resize", this._onSplitterResize.bind(this));
						this._colHeaderBar.ibxWidget("add", splitter);
					}
				},
				getCell:function(idxRow, idxCol)
				{
					var ret = null;
					var row = this.getRow(idxRow);
					var filter = (Number.isInteger(idxCol)) ? sformat(".dgrid-cell:nth-child({1})", idxCol+1) : idxCol;
					return $(row).children(filter)[0] || null;
				},
				getRow:function(idxRow)
				{
					var filter = (Number.isInteger(idxRow)) ? sformat(".dgrid-row:nth-child({1})", idxRow+1) : idxRow;
					return this._grid.children(filter)[0] || null;
				},
				addRow:function(cells, sibling, before, refresh)
				{
					var options = this.options;
					var row = $("<div>").ibxHBox().ibxAddClass(options.classes.gridRow);

					//trim extra cells...or if not enough, pad missing cells.
					cells = cells.slice(0, options.colMap.length);
					while(cells.length < options.colMap.length)
						cells.push($("<div class='dgrid-cell-padding'>")[0]);

					row.append(cells);
					this._grid.append(row);
					$(cells).ibxAddClass("dgrid-cell").data("ibxGridRow", row[0]);

					if(refresh)
						this.refresh();
					return row[0];
				},
				removeRow:function(row, destroy, refresh)
				{
					this._grid.ibxWidget("remove", row, destroy, refresh);
				},
				removeAll:function()
				{
					this._grid.ibxWidget("remove");
				},
				_onSplitterResize:function(e, resizeInfo)
				{
					var splitter = $(e.target);
					var sWidth = splitter.outerWidth();
					var e1lWidth = resizeInfo.el1.outerWidth();
					var colMap = this.options.colMap;

					var idxEl = splitter.siblings(".dgrid-header-col").index(resizeInfo.el1);
					var cells = this._grid.find(sformat(".dgrid-row > .dgrid-cell:nth-child({1})", idxEl+1));
					cells.outerWidth(e1lWidth + sWidth);
				},
				_setOption:function(key, value)
				{
					this._super(key, value);
					if(key == "colMap")
					{
						this._buildHeaders();
					}
				},
				_refresh:function()
				{
					var options = this.options;
					options.cols = options.showRowHeaders ? "auto 1fr" : "0px 1fr";
					options.rows = options.showColHeaders ? "auto 1fr" : "0px 1fr";
					this._colHeaderBar.css("display", options.showColHeaders ? "" : "none");
					this._rowHeaderBar.css("display", options.showRowHeaders ? "" : "none");
					this._super();

					if(options.colMap.length)
					{
						var sWidth = $(this._colHeaderBar[0].querySelector(".dgrid-header-col-splitter")).outerWidth();
						var colMap = options.colMap;
						for(var i = 0; i < colMap.length; ++i)
						{
							var cells = this._grid.find(sformat(".dgrid-row > .dgrid-cell:nth-child({1})", i+1));
							var size = (colMap[i]._curSize || colMap[i].size);
							(colMap[i].size == "*") ? cells.css({"flex":"1 1 auto", "width":"1px"}) : cells.outerWidth(size + sWidth);
						}
					}
				}
			});

					
			//# sourceURL=test_res_bundle.xml
		]]>
		</script-block>
	</scripts>
</ibx-res-bundle>