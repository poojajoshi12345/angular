<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ibx Shell Tool 1 STANDALONE</title>
		<meta http-equiv="X-UA-Compatible" content="IE=11">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<meta name="google" value="notranslate">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script type="text/javascript" src="../../../resources/ibx.js"></script>
		<script type="text/javascript">
			ibx(function(e)
			{
				var appParms = ibx.getAppParms();
				if(appParms.ibxShellToolId)
				{
					//setup tool for running as plugin
					window._ibxShellTool = new ibxShellTool(appParms.ibxShellToolId);
					window.addEventListener(ibxShellTool.msgGetShellToolResources, function(e)
					{
						//return cached resrouces if already retrieved.
						if(window._ibxShellTool.shellUI)
							return window._ibxShellTool.shellUI;

						var data = e.data.data; 
						var shellUI = e.data.shellUI;
						var shellRes = ibx.resourceMgr.getResource(".tool-container", false);

						shellRes = ibx.bindElements(shellRes);
						shellUI.commands = shellRes.find(".ibx-command");
						shellUI.menuHelp = shellRes.find(".tool-help-menu");//.ibxWidget("children"),
						shellUI.menuBar = shellRes.find(".tool-menubar");
						shellUI.toolBar = shellRes.find(".tool-toolbar");
						shellUI.commands.filter(".cmd-new-shape").on("ibx_triggered", onNewShape);
						shellUI.commands.filter(".cmd-del-shape").on("ibx_triggered", onDeleteShape);
						shellUI.commands.filter(".cmd-about").on("ibx_triggered", onAppAbout);
						shellUI.commands.filter(".cmd-help").on("ibx_triggered", onAppHelp);
					})
					window.addEventListener(ibxShellTool.msgSerialize, function(e)
					{
						var data = serialize(e.data.read);
						e.data.data;
					});
					$("body", document).on("focusin", function(e)
					{
						if(!e.relatedTarget)
							window._ibxShellTool.activate(true, true, {"hint":"focusin"});
					});

					var shapeContainer = ibx.resourceMgr.getResource(".shape-container");
					shapeContainer.appendTo("body").on("ibx_selchange", function(e)
					{
						var data = e.originalEvent.data;
						var items = getSelectedItems();
						window._ibxShellTool.shellUI.commands.filter(".cmd-del-shape").ibxWidget("option", "disabled", !items.length);
						window._ibxShellTool.activate(true, true, {"hint":"selchange", "selected":data.selected, "items":items})
					});
				}
				else
				{
					//Setup tool for running standalone
					var tool = ibx.resourceMgr.getResource(".tool-container", true);
					tool.find(".cmd-new-shape").on("ibx_triggered", onNewShape);
					tool.find(".cmd-del-shape").on("ibx_triggered", onDeleteShape);
					tool.find(".cmd-about").on("ibx_triggered", onAppAbout);
					tool.find(".cmd-help").on("ibx_triggered", onAppHelp);
					tool.find(".shape-container").on("ibx_selchange", function(e)
					{
						var selItems = getSelectedItems();
						$(".cmd-del-shape").ibxWidget("option", "disabled", !selItems.length);
					});
					$("body").append(tool);

				}


				/**************************************************************
				 * GENERAL COMMAND HANDLERS REGARDLESS OF HOW TOOL IS RUNNING *
				**************************************************************/
				function onNewShape(e)
				{
					var shape = $("<div tabindex='0' class='tool-shape'>").ibxWidget().uniqueId();
					$(".shape-container").append(shape);
				}
				function onDeleteShape(e)
				{
					var sm = $(".shape-container").ibxSelectionManager("instance");
					selItems = sm.selected();
					selItems.remove();
				};
				function onAppAbout(e)
				{
					alert("Tool for Drawing Squares!");
				};
				function onAppHelp(e)
				{
					alert("Open Square tool help page!");
				};
				function getSelectedItems()
				{
					var sm = $(".shape-container").ibxSelectionManager("instance");
					var ids = sm.selected().map(function(idx, item)
					{
						return item.id;
					});
					return ids.toArray();
				}
				function serialize(read)
				{
					if(!read)//writing out
					{
						var data = {};
						var items = $(".tool-shape");
						items.each(function(idx, el)
						{
							var style = window.getComputedStyle(el);
							var item = {};
							item.type = "square",
							item.width = style.width;
							item.height = style.height;
							item.border = style.border;
							item.background = style.backgroundColor;
							data[el.id] = item;
						});
						return JSON.stringify(data);

					}
					else//reading in
					{
					}
				}
			}, [{src:"./shell.ibx.tool1.res.xml", loadContext:"app"}], true);
		</script>
		<style type="text/css">
			body, .tool-container
			{
				margin:0px;
				position:absolute;
				width:100%;
				height:100%;
				box-sizing:border-box;
			}
			.tool-menubar
			{
				flex:0 0 auto;
				border-bottom:1px solid #ccc;
			}
			.tool-toolbar
			{
				flex:0 0 auto;
				padding:3px;
				border-bottom:1px solid #ccc;
			}
			.shape-container
			{
				flex: 1 1 auto;
				width:100%;
				height:100%;
				box-sizing:border-box;
			}
			.tool-shape
			{
				outline:none;
				flex:0 0 auto;
				width:50px;
				height:50px;
				border:2px solid green;
				background-color:white;
				margin:5px;
			}
			.tool-shape.ibx-sm-selected
			{
				background-color:lightgreen;
			}
		</style>
	</head>
	<body class="ibx-root">
	</body>
</html>


