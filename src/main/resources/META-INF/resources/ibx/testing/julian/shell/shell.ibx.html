<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ibx Pluggable Shell</title>
		<meta http-equiv="X-UA-Compatible" content="IE=11">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<meta name="google" value="notranslate">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script type="text/javascript" src="../../../resources/ibx.js"></script>
		<script type="text/javascript">
			ibx(function(e)
			{
				//setup the shell app ui.
				var shell = ibx.resourceMgr.getResource(".app-ui", true).children();
				$("body").append(shell);

				var activeTools = ibx.getAppParms().tools.split(",");
				var shellConfig = 
				{
					//ui resources tool can donate (general)...tools can override.
					shellUI:
					{
						commands:null,
						shellMenu:null,
						menuHelp:null,
						menuBar:null,
						toolBar:null
					},

					//configured shell tools (plugins)
					tools:
					{
						tool1:
						{
							active: (activeTools.indexOf("tool1") != -1),
							title:"Squares",
							icon:"something.whatever",
							class:"squares-plugin",
							host:"iframe",
							src:"./shell.ibx.tool1.html",
						},
						tool2:
						{
							active: (activeTools.indexOf("tool2") != -1),
							title:"Circles",
							icon:"something.whatever",
							class:"squares-plugin",
							host:"iframe",
							src:"./shell.ibx.tool2.html",
						}
					}
				}

				//get everything up and running
				window._ibxShellApp = new ibxShellApp(shellConfig);
				initShell(shellConfig);

				//attach our commands.
				$(".cmd-new").on("ibx_triggered", function(e)
				{
					var type = $(e.relatedTarget).ibxWidget("option", "tool");
					var tool = window._ibxShellApp.config.tools[type];
					var toolInfo = window._ibxShellApp.createTool(type);
					var wnd = makeToolWindow().ibxAddClass(tool.class).data("ibxShellTool", toolInfo);

					wnd.find(".tool-content").append(toolInfo.host);
					$(".tool-area").append(wnd);
					toolInfo.createDeferred.then(function()
					{
						var caption = sformat("{1} ({2})", tool.title, $("." + tool.class).length)
						wnd.find(".title-caption").ibxWidget("option", "text", caption);
						wnd.ibxRemoveClass("creating");
						activatePlugin(toolInfo.id);
					});
				});
				$(".cmd-save, .cmd.save-as").on("ibx_triggered", function(e)
				{
					var wnd = $(".wnd-active");
					if(!wnd.length)
						return;

					var toolInfo = wnd.data("ibxShellTool");
					var data = toolInfo.tool.serialize(false);
					var strAlert = sformat("Serialized Data for Active Tool Window:\n{1}", data);
					alert(strAlert);
				});
				$(".cmd-about").on("ibx_triggered", function(e)
				{
					alert("ibxShellApp Example...let's you get plugged in!");
				});

				$(".tool-area").on("focus", function(e)
				{
					var toolInfo = activeTool();
					deactivatePlugin(toolInfo.id);
				});

				window.addEventListener(ibxShellApp.msgActivateTool, function(e)
				{
					var activateInfo = e.data;
					activatePlugin(activateInfo.id, false, activateInfo);
				});
				window.addEventListener(ibxShellApp.msgUpdateToolUI, function(e)
				{
					var updateInfo = e.data;
					activatePlugin(updateInfo.id, true, updateInfo);
				});
			},[{"src":"./shell.ibx.res.xml", "loadContext":"app"}], true);
			function activeTool()
			{
				var wnd = $(".wnd-active");
				var toolInfo = wnd.data("ibxShellTool") || {id:null};
				return toolInfo;
			};

			function activatePlugin(idTool, updateUI, data)
			{
				//see if the tool is currently running...and window isn't already the active one.
				var toolInfo = window._ibxShellApp.runningTools[idTool];
				var wnd = $(toolInfo.host).closest(".tool-window");
				if(!wnd.is(".wnd-active"))
				{
					//deactivate the currently active tool
					var toolInfoActive = activeTool();
					deactivatePlugin(toolInfoActive.id);
				}

				//merge the tool's ui if requested.
				if((updateUI === undefined) || updateUI)
				{
					console.log("activatePlugin", data ? data.type : "no type", data);

					wnd.ibxAddClass("wnd-active");
					var toolInfo = wnd.data("ibxShellTool");
					var manifest = window._ibxShellApp.config.tools[toolInfo.type];
					var shellUI = manifest.shellUI || window._ibxShellApp.config.shellUI;
					shellUI = toolInfo.tool.getResources(jQuery, shellUI, data);

					$(".help-menu").ibxWidget("option", "menu").ibxWidget("add", shellUI.menuHelp.ibxWidget("children").addClass("ibx-plugin-help-item"));
					$(".main-menubar").ibxWidget("add", shellUI.menuBar, ".help-menu", true); 
					$(".main-toolbar").append(shellUI.toolBar); 

					//must add commands into the static array on activation
					shellUI.commands.each(function(idx, cmd)
					{
						cmd = $(cmd);
						var id = cmd.ibxWidget("option", "id");
						$.ibi.ibxCommand.cmds[id] = cmd;
					});
				}
			}
			function deactivatePlugin(idTool)
			{
				return;
				var toolInfo = window._ibxShellApp.tools[idTool];
				var wnd = toolInfo ? toolInfo.wnd : $();
				if(!wnd.is(".wnd-active"))
					return;

				wnd.ibxRemoveClass("wnd-active");
				var toolInfo = wnd.data("ibxShellTool");
				if(toolInfo)
				{
					toolInfo.ui.helpmenu.ibxWidget("add", $(".ibx-plugin-help-item"));
					toolInfo.ui.menubar.detach();
					toolInfo.ui.toolbar.detach();

					//must remove commands from static array on deactivation
					toolInfo.ui.commands.each(function(idx, cmd)
					{
						var id = $(cmd).ibxWidget("option", "id");
						delete $.ibi.ibxCommand.cmds[id]
					});
				}
			}

			function initShell(shellConfig)
			{
				var menu = $(".new-tool-menu");
				var tbar = $(".tbar");
				$.each(shellConfig.tools, function(key, tool)
				{
					if(!tool.active)
						return;

					var menuItem = $("<div>").text(tool.title).ibxMenuItem({"command":"cmdNew", "tool":key});
					menu.ibxWidget("add", menuItem);

					var tbButton = $("<div tabindex='0' class='tbar-btn shell-tool-tb-btn' title='New Tool Window'>").text(sformat("New {1}", tool.title)).ibxButton({"command":"cmdNew", "tool":key});
					tbar.ibxWidget("add", tbButton);
				});
				if($(".shell-tool-tb-btn").length)
					tbar.ibxWidget("add", $("<div class='tbar-sep'>"));
			}

			function makeToolWindow()
			{
				var container = $(".tool-area");
				var wnd = $(".tool-window-template").clone().ibxRemoveClass("tool-window-template").removeAttr("data-ibx-no-bind").ibxAddClass("creating");
				wnd = ibx.bindElements(wnd);
				wnd.draggable({handle:wnd.find(".title-bar"), containment:container}).resizable({containment:container}).css("position", "absolute").on("dragstart dragstop resizestart resizeend", function(e)
				{
					var wnd = $(e.currentTarget);
					var start = (e.type == "dragstart" || e.type == "resizestart");
					wnd.find(".ibx-shell-tool-frame").css("pointerEvents", start ? "none" : "");	
				});
				wnd.find(".title-close").on("click", function(e)
				{
					var wnd = $(e.target).closest(".tool-window");
					var toolInfo = wnd.data("ibxShellTool");
					deactivatePlugin(toolInfo.id);
					wnd.remove();
				});
				wnd.on("mousedown focusin", function(e)
				{
					var wnd = $(e.target).closest(".tool-window");
					var toolInfo = wnd.data("ibxShellTool");
					activatePlugin(toolInfo.id);
				});
				return wnd;
			}
		</script>
		<style type="text/css">
		</style>
	</head>
	<body class="ibx-root" data-ibx-type="ibxVBox" data-ibxp-align="stretch">
	</body>
</html>


